name: ğŸš€ Release and Publish

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      REGISTRY: https://registry.npmjs.org
    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: ${{ env.REGISTRY }}

      - name: ğŸ“ è¯»å– package åç§°ä¸ç‰ˆæœ¬
        id: pkg
        run: |
          echo "name=$(jq -r .name package.json)" >> $GITHUB_OUTPUT
          echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: ğŸŒ æ£€æŸ¥ç›®æ ‡ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
        id: published
        run: |
          PACKAGE="${{ steps.pkg.outputs.name }}"
          VERSION="${{ steps.pkg.outputs.version }}"
          EXISTS=$(npm view "$PACKAGE@$VERSION" --registry $REGISTRY > /dev/null 2>&1 && echo "true" || echo "false")
          echo "exists=$EXISTS" >> $GITHUB_OUTPUT

      - name: âœ… å†³å®šæ˜¯å¦éœ€è¦å‘å¸ƒ
        id: decide
        run: |
          if [ "${{ steps.published.outputs.exists }}" = "true" ]; then
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ å‡†å¤‡ pnpm
        if: steps.decide.outputs.should_publish == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9.13.2
          run_install: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_REGISTRY: ${{ env.REGISTRY }}

      # - name: ğŸ” å‡†å¤‡ npm auth
      #   if: steps.decide.outputs.should_publish == 'true'
      #   run: |
      #     echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: ğŸ” è¿›è¡Œç±»å‹æ£€æŸ¥
        if: steps.decide.outputs.should_publish == 'true'
        run: tsc --noEmit

      - name: ğŸ§¾ é¢„è§ˆå°†è¢«æ‰“åŒ…çš„å†…å®¹
        if: steps.decide.outputs.should_publish == 'true'
        run: npm pack --dry-run

      - name: ğŸ§¹ åˆ é™¤å¼€å‘ä¾èµ–
        run: pnpm pkg delete devDependencies
        if: steps.decide.outputs.should_publish == 'true'

      - name: ğŸš€ å‘å¸ƒåˆ° NPM
        if: steps.decide.outputs.should_publish == 'true'
        id: npm_publish
        env:
          PACKAGE_NAME: ${{ steps.pkg.outputs.name }}
          LOCAL_VERSION: ${{ steps.pkg.outputs.version }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -e
          VERSION="$LOCAL_VERSION"
          TAG_FLAG=""
          if echo "$VERSION" | grep -Eiq "alpha|beta|rc|next"; then
            TAG_NAME=$(echo "$VERSION" | grep -Eoi "alpha|beta|rc|next" | head -n1)
            TAG_FLAG="--tag $TAG_NAME"
          else
            TAG_FLAG=""
          fi


          echo "å‘å¸ƒ: $PACKAGE_NAME@$VERSION"
          echo "Tag å‚æ•°: $TAG_FLAG"

          if [ -z "$TAG_FLAG" ]; then
            npm publish --access public
          else
            npm publish --access public $TAG_FLAG
          fi

      - name: ğŸ”„ åŒæ­¥åˆ°å›½å†…é•œåƒæº
        if: steps.decide.outputs.should_publish == 'true'
        env:
          PACKAGE_NAME: ${{ steps.pkg.outputs.name }}
        run: |
          curl -X PUT "https://registry-direct.npmmirror.com/-/package/$PACKAGE_NAME/syncs"

      - name: ğŸ”– ç¡®å®šæ˜¯å¦ä¸º prereleaseï¼ˆalpha/beta/rcï¼‰
        if: steps.decide.outputs.should_publish == 'true'
        id: release_type
        run: |
          VERSION="${{ steps.pkg.outputs.version }}"
          if echo "$VERSION" | grep -qi "alpha\|beta\|rc"; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ åˆ›å»ºå¹¶ push Git tag
        if: steps.decide.outputs.should_publish == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          TAG="v${{ steps.pkg.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # è‹¥ tag å·²å­˜åœ¨åˆ™è·³è¿‡
          if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping tag creation."
          else
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "Pushed tag $TAG"
          fi

      - name: ğŸ“ ç”Ÿæˆ Release Notes
        if: steps.decide.outputs.should_publish == 'true'
        id: notes
        run: |
          set -e
          TAG="v${{ steps.pkg.outputs.version }}"

          # ä¿è¯æœ‰æ‰€æœ‰å†å²
          git fetch --prune --unshallow || true

          PREV_TAG=$(git describe --tags --abbrev=0 "$TAG^" 2>/dev/null || true)

          if echo "$TAG" | grep -Eq "alpha|beta|rc"; then
           # é¢„å‘å¸ƒï¼Œæ­£å¸¸ç”Ÿæˆæ—¥å¿—
           if [ -n "$PREV_TAG" ]; then
            NOTES=$(git log --no-merges --pretty=format:'- %s (%h)' "${PREV_TAG}..HEAD")
           else
            NOTES=$(git log --no-merges --pretty=format:'- %s (%h)' -n 50)
           fi
          else
          # æ­£å¼ç‰ˆï¼Œåˆå¹¶æ‰€æœ‰è‡ªä¸Šä¸€ä¸ªæ­£å¼ç‰ˆä»¥æ¥çš„æ—¥å¿—
          # æ‰¾åˆ°ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆ tag
          LAST_STABLE_TAG=$(git tag --list "v*" --sort=-creatordate | grep -Ev "alpha|beta|rc" | grep -v "^$TAG$" | head -n1)
          if [ -n "$LAST_STABLE_TAG" ]; then
            NOTES=$(git log --no-merges --pretty=format:'- %s (%h)' "${LAST_STABLE_TAG}..HEAD")
          else
            NOTES=$(git log --no-merges --pretty=format:'- %s (%h)' -n 50)
          fi
            fi

            # å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œå†™ä¸€è¡Œæç¤º
            if [ -z "$NOTES" ]; then
              NOTES="No changelog available."
            fi

            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "$NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ åˆ›å»º GitHub Release
        if: steps.decide.outputs.should_publish == 'true'
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ steps.pkg.outputs.version }}"
          name: "v${{ steps.pkg.outputs.version }}"
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ steps.release_type.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
